<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Navigation Links Fix - January 3, 2026# Problem# After securing the S3 bucket (making it private with CloudFront OAC), navigation links stopped working and returned 403 AccessDenied errors.
Root Cause# When we secured S3, we switched from the S3 website endpoint to the S3 bucket endpoint:
Before: klm-plan.s3-website-us-east-1.amazonaws.com (website endpoint) After: klm-plan.s3.us-east-1.amazonaws.com (bucket endpoint) The S3 website endpoint automatically serves index.html for directory requests:
Request: /lines-of-business/ Serves: /lines-of-business/index.html But the S3 bucket endpoint does NOT have this behavior - it requires the exact object key.
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://localhost:1313/documents/klm-plan/navigation-fix/"><meta property="og:site_name" content="My Projects - Documentation Hub"><meta property="og:title" content="NAVIGATION-FIX"><meta property="og:description" content="Navigation Links Fix - January 3, 2026# Problem# After securing the S3 bucket (making it private with CloudFront OAC), navigation links stopped working and returned 403 AccessDenied errors.
Root Cause# When we secured S3, we switched from the S3 website endpoint to the S3 bucket endpoint:
Before: klm-plan.s3-website-us-east-1.amazonaws.com (website endpoint) After: klm-plan.s3.us-east-1.amazonaws.com (bucket endpoint) The S3 website endpoint automatically serves index.html for directory requests:
Request: /lines-of-business/ Serves: /lines-of-business/index.html But the S3 bucket endpoint does NOT have this behavior - it requires the exact object key."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="documents"><meta property="article:published_time" content="2026-01-03T10:08:55+00:00"><meta property="article:modified_time" content="2026-01-03T10:08:55+00:00"><meta itemprop=name content="NAVIGATION-FIX"><meta itemprop=description content="Navigation Links Fix - January 3, 2026# Problem# After securing the S3 bucket (making it private with CloudFront OAC), navigation links stopped working and returned 403 AccessDenied errors.
Root Cause# When we secured S3, we switched from the S3 website endpoint to the S3 bucket endpoint:
Before: klm-plan.s3-website-us-east-1.amazonaws.com (website endpoint) After: klm-plan.s3.us-east-1.amazonaws.com (bucket endpoint) The S3 website endpoint automatically serves index.html for directory requests:
Request: /lines-of-business/ Serves: /lines-of-business/index.html But the S3 bucket endpoint does NOT have this behavior - it requires the exact object key."><meta itemprop=datePublished content="2026-01-03T10:08:55+00:00"><meta itemprop=dateModified content="2026-01-03T10:08:55+00:00"><meta itemprop=wordCount content="391"><title>NAVIGATION-FIX | My Projects - Documentation Hub</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=http://localhost:1313/documents/klm-plan/navigation-fix/><link rel=stylesheet href=/book.min.cc2c524ed250aac81b23d1f4af87344917b325208841feca0968fe450f570575.css integrity="sha256-zCxSTtJQqsgbI9H0r4c0SRezJSCIQf7KCWj+RQ9XBXU=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.da5a5af27f9bdea67bd6f07f3142824ec301e0c7f9d37c0fc61aefc961834a9e.js integrity="sha256-2lpa8n+b3qZ71vB/MUKCTsMB4Mf503wPxhrvyWGDSp4=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-documents"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>My Projects - Documentation Hub</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>NAVIGATION-FIX</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#navigation-links-fix---january-3-2026>Navigation Links Fix - January 3, 2026</a><ul><li><a href=#problem>Problem</a><ul><li><a href=#root-cause>Root Cause</a></li></ul></li><li><a href=#solution>Solution</a><ul><li><a href=#updated-lambda-function-version-2>Updated Lambda Function (Version 2)</a></li><li><a href=#why-this-approach>Why This Approach?</a></li></ul></li><li><a href=#files-modified>Files Modified</a></li><li><a href=#deployment>Deployment</a></li><li><a href=#testing>Testing</a></li><li><a href=#status>Status</a></li><li><a href=#technical-details>Technical Details</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=navigation-links-fix---january-3-2026>Navigation Links Fix - January 3, 2026<a class=anchor href=#navigation-links-fix---january-3-2026>#</a></h1><h2 id=problem>Problem<a class=anchor href=#problem>#</a></h2><p>After securing the S3 bucket (making it private with CloudFront OAC), navigation links stopped working and returned <strong>403 AccessDenied</strong> errors.</p><h3 id=root-cause>Root Cause<a class=anchor href=#root-cause>#</a></h3><p>When we secured S3, we switched from the S3 <strong>website endpoint</strong> to the S3 <strong>bucket endpoint</strong>:</p><ul><li><strong>Before</strong>: <code>klm-plan.s3-website-us-east-1.amazonaws.com</code> (website endpoint)</li><li><strong>After</strong>: <code>klm-plan.s3.us-east-1.amazonaws.com</code> (bucket endpoint)</li></ul><p>The S3 website endpoint automatically serves <code>index.html</code> for directory requests:</p><ul><li>Request: <code>/lines-of-business/</code></li><li>Serves: <code>/lines-of-business/index.html</code></li></ul><p>But the S3 bucket endpoint does NOT have this behavior - it requires the exact object key.</p><h2 id=solution>Solution<a class=anchor href=#solution>#</a></h2><p>Updated the Lambda@Edge function (<code>lambda-auth.js</code>) to handle BOTH authentication AND index.html rewriting in a single function.</p><h3 id=updated-lambda-function-version-2>Updated Lambda Function (Version 2)<a class=anchor href=#updated-lambda-function-version-2>#</a></h3><p>The function now:</p><ol><li><strong>Step 1</strong>: Rewrites URIs to append <code>index.html</code> for directory requests</li><li><strong>Step 2</strong>: Checks authentication credentials</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Step 1: Handle index.html for directory requests
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>uri</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>uri</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>uri</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;/&#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>uri</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;index.html&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>uri</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;.&#39;</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>uri</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;/&#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>uri</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;/index.html&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Step 2: Require Basic Authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ... existing auth code ...
</span></span></span></code></pre></div><h3 id=why-this-approach>Why This Approach?<a class=anchor href=#why-this-approach>#</a></h3><p>We tried creating a separate CloudFront Function for index.html handling, but CloudFront only allows one function per event type in a cache behavior. Since we already had Lambda@Edge on <code>viewer-request</code> for authentication, we combined both functions.</p><p><strong>Benefits:</strong></p><ul><li>Single function handles both concerns</li><li>Maintains proper execution order (rewrite before auth)</li><li>Simpler configuration</li><li>Lower latency than two separate functions</li></ul><h2 id=files-modified>Files Modified<a class=anchor href=#files-modified>#</a></h2><ol><li><strong>lambda-auth.js</strong>: Added index.html rewriting logic</li><li><strong>attach-lambda.py</strong>: Updated to use Lambda version 2</li></ol><h2 id=deployment>Deployment<a class=anchor href=#deployment>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Update Lambda function code</span>
</span></span><span style=display:flex><span>zip lambda-auth.zip lambda-auth.js
</span></span><span style=display:flex><span>aws lambda update-function-code <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --function-name klm-plan-basic-auth <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --zip-file fileb://lambda-auth.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Publish new version (v2)</span>
</span></span><span style=display:flex><span>aws lambda publish-version --function-name klm-plan-basic-auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Update CloudFront to use v2</span>
</span></span><span style=display:flex><span>python3 attach-lambda.py</span></span></code></pre></div><h2 id=testing>Testing<a class=anchor href=#testing>#</a></h2><p>After the CloudFront deployment completes (5-10 minutes), test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Homepage (should work)</span>
</span></span><span style=display:flex><span>curl -u <span style=color:#e6db74>&#34;klm:KLM2026Plan!&#34;</span> https://d1jrr6wppi7k7d.cloudfront.net/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Navigation link (should work now)</span>
</span></span><span style=display:flex><span>curl -u <span style=color:#e6db74>&#34;klm:KLM2026Plan!&#34;</span> https://d1jrr6wppi7k7d.cloudfront.net/lines-of-business/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Specific page (should work)</span>
</span></span><span style=display:flex><span>curl -u <span style=color:#e6db74>&#34;klm:KLM2026Plan!&#34;</span> https://d1jrr6wppi7k7d.cloudfront.net/products/new-ideas/</span></span></code></pre></div><p>All should return HTTP 200 with content.</p><h2 id=status>Status<a class=anchor href=#status>#</a></h2><p>‚úÖ <strong>Fixed</strong>: Lambda@Edge v2 deployed to CloudFront distribution E1Z0GEJNAKEO42
‚è≥ <strong>Propagating</strong>: Changes will be live across all edge locations in 5-10 minutes
üîê <strong>Security</strong>: Authentication still enforced (klm/KLM2026Plan!)
üì± <strong>Mobile Editing</strong>: Unchanged - still works via GitHub</p><h2 id=technical-details>Technical Details<a class=anchor href=#technical-details>#</a></h2><ul><li><strong>Lambda Function</strong>: <code>klm-plan-basic-auth:2</code></li><li><strong>CloudFront Distribution</strong>: <code>E1Z0GEJNAKEO42</code></li><li><strong>Event Type</strong>: <code>viewer-request</code></li><li><strong>Execution Order</strong>: URI rewrite ‚Üí Authentication ‚Üí S3 fetch</li></ul><hr><p><strong>Result</strong>: All navigation links now work correctly with the secured private S3 bucket!</p><p>Last Updated: 2026-01-03</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#navigation-links-fix---january-3-2026>Navigation Links Fix - January 3, 2026</a><ul><li><a href=#problem>Problem</a><ul><li><a href=#root-cause>Root Cause</a></li></ul></li><li><a href=#solution>Solution</a><ul><li><a href=#updated-lambda-function-version-2>Updated Lambda Function (Version 2)</a></li><li><a href=#why-this-approach>Why This Approach?</a></li></ul></li><li><a href=#files-modified>Files Modified</a></li><li><a href=#deployment>Deployment</a></li><li><a href=#testing>Testing</a></li><li><a href=#status>Status</a></li><li><a href=#technical-details>Technical Details</a></li></ul></li></ul></nav></div></aside></main></body></html>